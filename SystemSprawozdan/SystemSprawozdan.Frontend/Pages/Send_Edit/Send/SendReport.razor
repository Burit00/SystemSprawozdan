@page "/send/{ReportTopicId}"
@using System.Net.Http.Headers;
@inject IAppHttpClient AppHttpClient

<PageTitle>Wyślij sprawozdanie</PageTitle>
<style>
    .main-container{
        display: flex;
        flex-direction: row;
        justify-content: space-evenly;
        align-content: flex-start;
        height: 100%;
        padding-bottom: 6vh;
    }
    .file-input{
        cursor: pointer;
        transition: background-color 400ms;
        border: dashed var(--primary-color) 4px;
        border-radius: 46px;
        background-image: url("Icons/Send_edit/download-icon.svg");
        background-size: 25%;
        background-position: center;
        background-repeat: no-repeat;
    }
    
    
    .file-input:hover{
        background-color: rgba(64,153,229,0.49);
    }
    
    input::file-selector-button{
        opacity: 0;
    }
    
    input[type="file"]{
        width: 100%;
        height: 65%;
        color: transparent;
        margin-bottom: 24px;
    }
    
    .files-list{
        height: 28%;
        overflow-y: scroll;
        border-radius: 15px;
    }
</style>

    <span class="report-topic-name">@TopicName</span>
    <div class="main-container">
        <div class="left-column">
            <span style="position: absolute; left: 50%; top: 50%; font-size: 2rem; transform: translate(-50%, -50%);">Umieść pliki</span>
            @for (int i = 0; i < numberOfInputFiles; i++)
            {
                <InputFile class="file-input" @key="i" OnChange="OnInputFileChange" multiple style="@GetInputFileStyle(i)"></InputFile>
            }
            <pre>@status</pre>
            
            <div class="files-list">
                @if (_files.Count > 0)
                {
                    <FilesList FilesToBeSent="_files" RemoveFile="RemoveFileFromList"></FilesList>
                }
            </div>
        </div>
        
        <div class="right-column">
            <p class="deadline">Termin oddania: @Deadline</p>
            <MatTextField TValue="string" @bind-Value="Note" Label="Komentarz dla prowadzącego:" Outlined="true" TextArea="true" Style="height: 50%;"/>
            <div class="radio-buttons__and-description">
                <p class="radio-button-description">Sposób oddania:</p>
                <div class="radio-buttons">
                    <MatRadioGroup @bind-Value="@IsIndividual" TValue="string" Style="display: flex">
                        <MatRadioButton Value="@("true")" TValue="string">Indywidualnie</MatRadioButton>
                        <MatRadioButton Value="@("false")" TValue="string">Grupowo</MatRadioButton>
                    </MatRadioGroup>
                </div>
            </div>
    
            <MatButton OnClick="@(() => sendReport())" Label="Prześlij" Unelevated="true" Class="send-button" Style="height: 12%"></MatButton>
        </div>
    </div>


@code {
    [Parameter]
    public string ReportTopicId { get; set; }
    
    string? status;
    int numberOfInputFiles = 1;

    string GetInputFileStyle(int index)
    {
        return index == numberOfInputFiles - 1 ? "" : "display: none";
    }
    
    
    public string IsIndividual { get; set; } = "true";
    public bool IsIndividualBool {get; set; }
    public string Note { get; set; } = string.Empty;
    public string Token { get; set; }
    public Uri reportTopicGetEndpointUri { get; set; }
    public string Deadline { get; set; }
    public string TopicName { get; set; }


    private readonly int _maxAllowedFiles = 100;
    private readonly long _maxFileSize = 5368709120; // 5 Gigabytes
    private List<IBrowserFile> _files = new();
    MultipartFormDataContent filesMultipartFormDataContent = new();

    public async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        numberOfInputFiles++;
        foreach (var file in e.GetMultipleFiles(_maxAllowedFiles))
        {
            _files.Add(file);
        }
    }
    
    
    public async void sendReport()
    {
        var sendReportUri = $"https://localhost:7184/api/StudentReport";
        IsIndividualBool = Boolean.Parse(IsIndividual);
        var reportToSend = new StudentReportPostDto
        {
            IsIndividual = IsIndividualBool,
            ReportTopicId = Int32.Parse(ReportTopicId),
            Note = Note
        };
        var sentReportResponse = await (AppHttpClient.Post(sendReportUri, reportToSend));
        var createdStudentReportId = Int32.Parse(sentReportResponse);

        if (_files is null)
        {
            return;
        }
        using var client = new HttpClient();
        client.DefaultRequestHeaders.Add("Authorization", "Bearer " + Token);
        var sendFilesUrl = $"https://localhost:7184/api/StudentReportFile/{createdStudentReportId}";
        foreach (var file in _files)
        {
            var fileContent = new StreamContent(file.OpenReadStream(_maxFileSize));
            var fileContentType = file.ContentType;
            var fileName = file.Name;
            if (fileContentType == "")
            {
                var extension = fileName.Split('.').Last();
                switch (extension)
                {
                    case "sql":
                    {
                        fileContent.Headers.ContentType = new MediaTypeHeaderValue("application/sql");
                        break;
                    }
                    default:
                    {
                        fileContent.Headers.ContentType = new MediaTypeHeaderValue("");
                        break;
                    }
                }
            }
            else
            {
                fileContent.Headers.ContentType = new MediaTypeHeaderValue(fileContentType);
            }
            filesMultipartFormDataContent.Add(
                content: fileContent,
                name: "\"files\"",
                fileName: file.Name);
        }
        var filesResponse = await client.PostAsync(sendFilesUrl, filesMultipartFormDataContent);
        filesResponse.EnsureSuccessStatusCode();
    }
    
    
    protected override async Task OnInitializedAsync()
    {
        var loginData = new LoginUserDto()
        {
            Login = "169571",
            Password = "Hasło123"
        };
        Token = await AppHttpClient.Post("Account/login", loginData);

        reportTopicGetEndpointUri =  new Uri($"https://localhost:7184/api/ReportTopic/?reportTopicId={ReportTopicId}");
        var reportTopicGetDto = await AppHttpClient.Get<ReportTopicGetDto>(reportTopicGetEndpointUri.ToString());
        Deadline = reportTopicGetDto.Deadline.ToString("g");
        TopicName = reportTopicGetDto.Name;
    }

    public void RemoveFileFromList(string name)
    {
        var fileObjectToRemove = _files.Find(f => f.Name == name);
        _files.Remove(fileObjectToRemove);
    }

}